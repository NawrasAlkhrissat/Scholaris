<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Class & Schedule</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/css/editClass.css">
</head>

<body>

    <%- include('./partials/nav.ejs') %>

        <div class="dashboard-container">

            <aside class="sidebar">
                <div class="sidebar-title">Main Menu</div>
                <a href="/school/user/<%= userId %>" class="sidebar-link active"><span>üë§</span><span>My
                        Profile</span></a>
                <a href="/school" class="sidebar-link"><span>üè´</span>My School</a>
                <a href="/school/subject" class="sidebar-link"><span>üìö</span><span>
                        <%= role=='admin' ? 'All Subjects' : 'My Subjects' %>
                    </span></a>
                <a href="/school/academic-calendar" class="sidebar-link"><span>üìÖ</span><span>Calendar</span></a>
            </aside>

            <main class="main-content">
                <a href="/school/class/<%= currentClass._id %>  " class="back-link">
                    <span>&larr;</span> Back to Class
                </a>
                <div class="page-header">
                    <h1 class="page-title">Edit Class: <%= currentClass.className %>
                    </h1>
                    <form action="/school/class/<%= currentClass._id %>?_method=DELETE" method="POST" id="delete-form">
                        <button type="submit" class="btn btn-danger">Delete Class</button>
                    </form>
                </div>

                <form id="editClassForm">

                    <div class="card">
                        <div class="card-header">Basic Information & Subjects</div>
                        <div class="form-grid-inner">

                            <div class="form-group">
                                <label>Class Name *</label>
                                <input type="text" id="className" class="form-input"
                                    value="<%= currentClass.className %>" required>
                            </div>

                            <div class="form-group">
                                <label>Capacity *</label>
                                <input type="number" id="capacity" class="form-input"
                                    value="<%= currentClass.capacity %>" required>
                            </div>

                            <div class="form-group full-width">
                                <label>Responsible Teacher</label>
                                <select id="responsibleTeacher" class="form-select">
                                    <option value="" disabled <%= currentClass.responsibleTeacher == null ? 'selected' : ''  %>>Select Teacher</option>
                                    <% teachers.forEach(teacher=> { %>
                                        <option value="<%= teacher._id %>" <%=  currentClass.responsibleTeacher && currentClass.responsibleTeacher._id.toString() == teacher._id.toString() ? 'selected' : '' %>>
                                            <%= teacher.firstName %>
                                                <%= teacher.lastName %>
                                        </option>
                                        <% }) %>
                                </select>
                            </div>

                            <div class="form-group full-width">
                                <label>Assigned Subjects (Fixed)</label>
                                <div class="subjects-readonly-list">
                                    <% if (currentClass.subjects && currentClass.subjects.length> 0) { %>
                                        <% currentClass.subjects.forEach(subject=> { %>
                                            <span class="subject-tag">
                                                <%= subject.subjectName %>
                                            </span>
                                            <% }) %>
                                                <% } else { %>
                                                    <span style="color: #999; font-style: italic;">No subjects assigned
                                                        yet.</span>
                                                    <% } %>
                                </div>
                            </div>

                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">Weekly Schedule Manager</div>

                        <div class="schedule-tabs">
                            <% const days=["Monday", "Tuesday" , "Wednesday" , "Thursday" , "Friday" , "Saturday"
                                , "Sunday" ]; %>
                                <% days.forEach((day, index)=> { %>
                                    <button type="button" class="tab-btn <%= index === 0 ? 'active' : '' %>"
                                        onclick="switchDay('<%= day %>')">
                                        <%= day %>
                                    </button>
                                    <% }) %>
                        </div>

                        <div id="periodsContainer" class="schedule-container"></div>

                        <button type="button" class="btn-add-period" onclick="addPeriod()">
                            <span>‚ûï</span> Add Period to <span id="currentDayLabel">Monday</span>
                        </button>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-submit">Save Changes</button>
                        <a href="/school/class/<%= currentClass._id %>" class="btn-cancel">Cancel</a>
                    </div>

                </form>
            </main>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script>
            const serverSchedule = <%- JSON.stringify(currentClass.schedule || []) %>;
            const allTeachers = <%- JSON.stringify(teachers) %>;
            const classSubjects = <%- JSON.stringify(currentClass.subjects) %>; 
        </script>
        <script>

            // --- State Management ---
            let currentDay = "Monday";
            let scheduleState = {
                "Monday": [], "Tuesday": [], "Wednesday": [], "Thursday": [], "Friday": [], "Saturday": [], "Sunday": []
            };
            serverSchedule.forEach(dayObj => {
                if (scheduleState[dayObj.day]) {
                    scheduleState[dayObj.day] = dayObj.periods || [];
                }
            });

            const periodsContainer = document.getElementById('periodsContainer');
            const currentDayLabel = document.getElementById('currentDayLabel');

            // --- Functions ---

            // 1. Switch Tabs
            window.switchDay = function (day) {
                currentDay = day;
                currentDayLabel.innerText = day;
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.innerText === day) btn.classList.add('active');
                });
                renderPeriods();
            }

            // 2. Render Periods
            function renderPeriods() {
                periodsContainer.innerHTML = '';
                const periods = scheduleState[currentDay];

                if (periods.length === 0) {
                    periodsContainer.innerHTML = `<div style="text-align:center; color:#ccc; padding:20px;">No periods scheduled for ${currentDay}</div>`;
                    return;
                }

                periods.forEach((period, index) => {
                    const row = document.createElement('div');
                    row.className = 'period-row';

                    const subjectOptions = classSubjects.map(s =>
                        `<option value="${s._id}" ${period.subject === s._id ? 'selected' : ''}>${s.subjectName}</option>`
                    ).join('');

                    let teacherName = "No Teacher Assigned";
                    const currentSubjectObj = classSubjects.find(s => s._id === period.subject);
                    if (currentSubjectObj && currentSubjectObj.teacher) {
                        teacherName = `${currentSubjectObj.teacher.firstName} ${currentSubjectObj.teacher.lastName}`;
                    }

                    row.innerHTML = `
                    <div class="period-num">
                        <label>#</label>
                        <strong>${index + 1}</strong>
                    </div>
                    <div>
                        <label>Start Time</label>
                        <input type="time" class="form-input" value="${period.startTime}" onchange="updatePeriod(${index}, 'startTime', this.value)">
                    </div>
                    <div>
                        <label>End Time</label>
                        <input type="time" class="form-input" value="${period.endTime}" onchange="updatePeriod(${index}, 'endTime', this.value)">
                    </div>
                    <div>
                        <label>Subject</label>
                        <select class="form-select" onchange="updateSubjectAndTeacher(${index}, this.value)">
                            <option value="" disabled ${!period.subject ? 'selected' : ''}>Select...</option>
                            ${subjectOptions}
                        </select>
                    </div>
                    <div>
                        <label>Teacher (Auto)</label>
                        <input type="text" class="form-input teacher-readonly" value="${teacherName}" disabled readonly>
                    </div>
                    <div class="period-action">
                        <label>&nbsp;</label>
                        <button type="button" class="btn-delete-row" onclick="removePeriod(${index})">üóëÔ∏è</button>
                    </div>
                `;
                    periodsContainer.appendChild(row);
                });
            }

            // 3. Update Period Data
            window.updatePeriod = function (index, field, value) {
                scheduleState[currentDay][index][field] = value;
            }

            // 4. Update Subject & Teacher
            window.updateSubjectAndTeacher = function (index, subjectId) {
                scheduleState[currentDay][index].subject = subjectId;
                const subjectObj = classSubjects.find(s => s._id === subjectId);
                if (subjectObj && subjectObj.teacher) {
                    scheduleState[currentDay][index].teacher = subjectObj.teacher._id;
                } else {
                    scheduleState[currentDay][index].teacher = null;
                }
                renderPeriods();
            }

            // 5. Add/Remove Logic
            window.addPeriod = function () {
                scheduleState[currentDay].push({
                    periodNumber: scheduleState[currentDay].length + 1,
                    subject: "", teacher: "", startTime: "08:00", endTime: "09:00"
                });
                renderPeriods();
            }

            window.removePeriod = function (index) {
                scheduleState[currentDay].splice(index, 1);
                scheduleState[currentDay].forEach((p, i) => p.periodNumber = i + 1);
                renderPeriods();
            }

            renderPeriods();

            // ==========================================
            // üõë VALIDATION LOGIC (ÿ™ÿµÿ≠Ÿäÿ≠ ÿ¥ÿßŸÖŸÑ)
            // ==========================================

            function timeToMinutes(timeStr) {
                if (!timeStr) return -1; // ÿ•ÿ±ÿ¨ÿßÿπ -1 ŸÅŸä ÿ≠ÿßŸÑ ŸÉÿßŸÜ ÿßŸÑŸàŸÇÿ™ ŸÅÿßÿ±ÿ∫ÿßŸã
                const [hours, minutes] = timeStr.split(':').map(Number);
                return (hours * 60) + minutes;
            }

            function validateScheduleConflicts() {

                for (const day in scheduleState) {
                    const periods = scheduleState[day];
                    // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸáŸÜÿßŸÉ ŸÅÿ™ÿ±ÿßÿ™ÿå ÿßŸÜÿ™ŸÇŸÑ ŸÑŸÑŸäŸàŸÖ ÿßŸÑÿ™ÿßŸÑŸä
                    if (!periods || periods.length === 0) continue;
                    for (let i = 0; i < periods.length; i++) {
                        const p1 = periods[i];
                        const start1 = timeToMinutes(p1.startTime);
                        const end1 = timeToMinutes(p1.endTime);

                        // 1. ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑÿ•ÿØÿÆÿßŸÑ ŸÑŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑŸàÿßÿ≠ÿØÿ©
                        if (start1 === -1 || end1 === -1) {
                            return `‚ö†Ô∏è Please enter valid times for all periods in ${day}.`;
                        }
                        if (start1 >= end1) {
                            return `‚ùå Invalid time in ${day} (Period #${i + 1}): Start time must be before End time.`;
                        }
                        for (let j = i + 1; j < periods.length; j++) {
                            const p2 = periods[j];
                            const start2 = timeToMinutes(p2.startTime);
                            const end2 = timeToMinutes(p2.endTime);
                            if (start1 < end2 && end1 > start2) {
                                return `‚ö†Ô∏è Conflict detected on ${day}: Period #${i + 1} (${p1.startTime}-${p1.endTime}) overlaps with Period #${j + 1} (${p2.startTime}-${p2.endTime}).`;
                            }
                        }
                    }
                }
                return null;
            }

            // --- SUBMISSION LOGIC ---
            document.getElementById('editClassForm').addEventListener('submit', async function (e) {
                e.preventDefault();

                // 1. Validation Check
                const errorMsg = validateScheduleConflicts();
                if (errorMsg) {
                    console.warn("Validation Failed:", errorMsg);
                    alert(errorMsg);
                    return;
                }

                // 2. Prepare Data
                const className = document.getElementById('className').value;
                const capacity = document.getElementById('capacity').value;
                const responsibleTeacher = document.getElementById('responsibleTeacher').value || null;
                const subjects = classSubjects.map(s => s._id);

                // 3. Format Schedule
                const formattedSchedule = Object.keys(scheduleState).map(day => {
                    return {
                        day: day,
                        periods: scheduleState[day]
                    };
                }).filter(d => d.periods.length > 0);

                // 4. Send Data
                const payload = {
                    className,
                    capacity,
                    responsibleTeacher,
                    subjects,
                    schedule: formattedSchedule
                };
                try {
                    const response = await fetch('/school/class/<%= currentClass._id %>?_method=PUT', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) {
                        window.location.href = '/school/class/<%= currentClass._id %>';
                    } else {
                        const err = await response.text();
                        alert('Error: ' + err);
                    }
                } catch (err) {
                    console.error(err);
                    alert('Network error');
                }
            });
            document.getElementById('delete-form').addEventListener('submit',function (e) {
                e.preventDefault();
                Swal.fire({
                    title: "Are you sure?",
                    text: "You won't be able to revert this!",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33",
                    confirmButtonText: "Yes, delete it!"
                }).then((result) => {
                    if (result.isConfirmed) {
                        e.target.submit();
                    }
                });
            })
        </script>

</body>

</html>